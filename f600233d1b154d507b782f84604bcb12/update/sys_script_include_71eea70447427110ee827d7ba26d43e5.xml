<?xml version="1.0" encoding="UTF-8"?><record_update table="sys_script_include">
    <sys_script_include action="INSERT_OR_UPDATE">
        <access>package_private</access>
        <active>true</active>
        <api_name>x_g_dis_atat.AlertProcessor</api_name>
        <caller_access/>
        <client_callable>false</client_callable>
        <description/>
        <name>AlertProcessor</name>
        <script><![CDATA[class AlertProcessor {

    constructor() {
        this.TRACKING_TABLE = "x_g_dis_atat_alerts_tracking";
    }

    process() {
        const processed = this.getTrackingData();
        Object.keys(processed).forEach(clin => {
            Object.keys(processed[clin]).forEach(group => {
                this.updateTrackingRecords(processed[clin][group]);
            });
        });
        return processed;
    }

    getTrackingData() {
        return new global.GlideQuery(this.TRACKING_TABLE)
            .where('status', 'new')
            .orderBy('clin')
            .orderBy('alert.group')
            .orderBy('alert.priority')
            .select('alert.group', 'alert.priority', 'alert.sys_id', 'clin', 'sys_id')
            .toArray(100)
            .reduce(function(r, a) {
                r[a.clin] = r[a.clin] || {};
                r[a.clin][a.alert.group] = r[a.clin][a.alert.group] || [];
                r[a.clin][a.alert.group].push(a);
                return r;
            }, {});
    }

    updateTrackingRecords(records) {
        const gr = new GlideRecord(this.TRACKING_TABLE);
        if (gr.get(records[0].sys_id)) {
            gr.status = 'processed';
            gr.update();
        }

        records.slice(1).forEach(record => {
            if (gr.get(record.sys_id)) {
                gr.status = 'omitted';
                gr.update();
            }
        });
    }
}]]></script>
        <sys_class_name>sys_script_include</sys_class_name>
        <sys_created_by>stephen.hayes</sys_created_by>
        <sys_created_on>2023-10-18 11:47:30</sys_created_on>
        <sys_id>71eea70447427110ee827d7ba26d43e5</sys_id>
        <sys_mod_count>2</sys_mod_count>
        <sys_name>AlertProcessor</sys_name>
        <sys_package display_value="ATAT" source="x_g_dis_atat">f600233d1b154d507b782f84604bcb12</sys_package>
        <sys_policy>read</sys_policy>
        <sys_scope display_value="ATAT">f600233d1b154d507b782f84604bcb12</sys_scope>
        <sys_update_name>sys_script_include_71eea70447427110ee827d7ba26d43e5</sys_update_name>
        <sys_updated_by>stephen.hayes</sys_updated_by>
        <sys_updated_on>2023-10-18 12:05:03</sys_updated_on>
    </sys_script_include>
</record_update>
